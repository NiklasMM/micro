<script>
micro.components = micro.components || {};

micro.components.VideoElement = class extends HTMLElement {
    createdCallback() {
        this._video = null;
        this.appendChild(
            document.importNode(document.querySelector("#micro-video-template").content, true)
        );
        this._data = {play: () => this.play()};
        micro.bind.bind(this.children, this._data);

        this._p = null;
        this._player = null;
    }

    ready() {
        if (this._p) {
            return this._p;
        }

        function importYt() {
            if (!micro.components.VideoElement._yt) {
                micro.components.VideoElement._yt = new Promise(resolve => {
                    window.onYouTubeIframeAPIReady = () => resolve(window.YT);
                    micro.util.import("https://www.youtube.com/iframe_api");
                });
            }
            return micro.components.VideoElement._yt;
        }

        this._p = (async() => {
            const yt = await importYt();
            await new Promise(resolve => {
                const url = new URL(this._video.url);
                const videoId = url.searchParams.get("v");
                const onReady = event => {
                    this._player = event.target;
                    resolve();
                };
                const onStateChange = event => {
                    if (event.data === 2 || event.data === 0) {
                        this.dispatchEvent(new CustomEvent("pause"));
                        if (event.data == 0) {
                            this._player.destroy();
                            this._player = null;
                            this._p = null;
                        }
                    } else if (event.data === 1) {
                        this.dispatchEvent(new CustomEvent("play"));
                    }
                };
                new yt.Player(
                    this.querySelector("div"),
                    {width: 480, height: 270, videoId, events: {onReady, onStateChange}}
                );
            });
        })().catch(micro.util.catch);

        return this._p;
    }

    get video() {
        return this._video;
    }

    set video(value) {
        this._video = value;
    }

    play({reset = false} = {}) {
        (async() => {
            await this.ready();
            if (reset) {
                this._player.seekTo(0);
            }
            this._player.playVideo();
         })().catch(micro.util.catch);
    }

    pause() {
        if (this._player) {
            this._player.pauseVideo();
        }
    }

    get duration() {
        return this._player ? this._player.getDuration() : 0;
    }

    get time() {
        return this._player ? this._player.getCurrentTime() : 0;
    }
}

document.addEventListener(
    "DOMContentLoaded", () => document.registerElement("micro-video", micro.components.VideoElement)
);
</script>

<template id="micro-video-template">
    <div data-onclick="play"><i class="fas fa-play"></i></div>
</template>

<style>
micro-video div {
    background: black;
    position: absolute;
    top: 0;
    right: 0;
    left: 0;
    bottom: 0;
    cursor: pointer;
}

micro-video i {
    position: absolute;
    top: 50%;
    left: 50%;
    color: white;
}

micro-video {
    position: relative;
    padding-top: calc(9 / 16 * 100%);
}

micro-video iframe[title] {
    position: absolute;
    top: 0;
    width: 100%;
    height: 100%;
}
</style>
